{% load static %}
<!DOCTYPE html>
<html lang="zxx" class="no-js">

<head>
	<!-- Mobile Specific Meta -->
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- Favicon-->
	<link rel="shortcut icon" href="{% static 'img/logo2.png' %}">
	<!-- Author Meta -->
	<meta name="author" content="CodePixar">
	<!-- Meta Description -->
	<meta name="description" content="">
	<!-- Meta Keyword -->
	<meta name="keywords" content="">
	<!-- meta character set -->
	<meta charset="UTF-8">
	<!-- Site Title -->
	<title>Baka Store</title>

	<!--
            CSS
            ============================================= -->
	<link rel="stylesheet" href="{% static 'css/linearicons.css' %}">
	<link rel="stylesheet" href="{% static 'css/owl.carousel.css' %}">
	<link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/themify-icons.css' %}">
	<link rel="stylesheet" href="{% static 'css/nice-select.css' %}">
	<link rel="stylesheet" href="{% static 'css/nouislider.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
	<link rel="stylesheet" href="{% static 'css/main.css' %}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<style>
        .single-product img {
            width: 100%;
            height: 350px; 
            object-fit: cover;
        }
		.about-us-widget {
			position: relative;
			z-index: 1;
			background: rgba(255, 255, 255, 0.108); 
			padding: 20px;
			border-radius: 10px;
		}
		
		.about-us-widget::before,
		.about-us-widget::after {
			content: '';
			position: absolute;
			z-index: -1;
			background-size: cover;
			background-position: center;
			width: 100px;
			height: 100px;
		}
		
		.about-us-widget::before {
			background-image: url('{% static "img/pngegg.png" %}'); 
			top: -20px;
			left: -20px;
		}
		
		.about-us-widget::after {
			background-image: url('{% static "img/naruto.png" %}'); 
			bottom: -20px;
			right: -20px;
		}
		
		.about-us-widget::before,
		.about-us-widget::after {
			opacity: 0.3; 
			transform: rotate(-15deg); 
			border-radius: 50%; 
		}

		.checkout-area {
			background-color: #f0f4f8;
		}
		
		.checkout-wrapper {
			display: flex;
			flex-wrap: wrap;
			gap: 2rem;
		}
		
		.checkout-main {
			flex: 1 1 60%;
			min-width: 300px;
		}
		
		.checkout-sidebar {
			flex: 1 1 30%;
			min-width: 300px;
		}
		
		.section-title {
			font-size: 1.8rem;
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 1.5rem;
			position: relative;
			padding-bottom: 0.5rem;
		}
		
		.section-title::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 0;
			width: 50px;
			height: 3px;
			background-color: #3498db;
		}
		
		.progress-steps {
			display: flex;
			justify-content: space-between;
			margin-bottom: 2rem;
		}
		
		.progress-step {
			display: flex;
			flex-direction: column;
			align-items: center;
			flex: 1;
			position: relative;
		}
		
		.progress-step::before {
			content: '';
			position: absolute;
			top: 20px;
			left: calc(-50% + 20px);
			width: 100%;
			height: 3px;
			background-color: #e0e0e0;
			z-index: 0;
		}
		
		.progress-step:first-child::before {
			display: none;
		}
		
		.progress-step.active .step-icon {
			background-color: #3498db;
			color: white;
		}
		
		.step-icon {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background-color: #e0e0e0;
			display: flex;
			justify-content: center;
			align-items: center;
			margin-bottom: 0.5rem;
			z-index: 1;
			transition: all 0.3s ease;
		}
		
		.account-card {
			background-color: white;
			border-radius: 10px;
			padding: 1.5rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}
		
		.account-info {
			display: flex;
			align-items: center;
			gap: 1rem;
		}
		
		.account-icon {
			font-size: 2.5rem;
			color: #3498db;
		}
		
		.user-email {
			font-weight: 600;
			color: #3498db;
		}
		
		.address-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
			gap: 1rem;
		}
		
		.address-card {
			position: relative;
			height: 100%;
		}
		
		.address-radio {
			position: absolute;
			opacity: 0;
			width: 100%;
			height: 100%;
			cursor: pointer;
		}
		
		.address-label {
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			height: 100%;
			padding: 1rem;
			background-color: white;
			border-radius: 10px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			transition: all 0.3s ease;
		}
		
		.address-radio:checked + .address-label {
			border: 2px solid #3498db;
			background-color: #ebf5fb;
		}
		
		.address-card.add-new button {
			height: 100%;
			border-radius: 10px;
			font-size: 1.1rem;
		}
		.address-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
			gap: 20px;
		}
		
		.address-card {
			position: relative;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			padding: 15px;
			transition: all 0.3s ease;
			background-color: #fff;
		}
		
		.address-card:hover {
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}
		
		.address-radio {
			position: absolute;
			opacity: 0;
		}
		
		.address-label {
			display: block;
			cursor: pointer;
			padding-right: 60px;
		}
		
		.address-content h5 {
			margin-bottom: 5px;
			color: #333;
		}
		
		.address-content p {
			color: #666;
		}
		
		.address-actions {
			position: absolute;
			top: 10px;
			right: 10px;
			display: flex;
			gap: 5px;
		}
		
		.btn-edit,
		.btn-delete {
			padding: 5px;
			width: 30px;
			height: 30px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s ease;
			border: none;
		}
		
		.btn-edit {
			background-color: #f0f0f0;
			color: #007bff;
		}
		
		.btn-delete {
			background-color: #f0f0f0;
			color: #dc3545;
		}
		
		.btn-edit:hover,
		.btn-delete:hover {
			transform: scale(1.1);
		}
		
		.btn-edit:hover {
			background-color: #007bff;
			color: #fff;
		}
		
		.btn-delete:hover {
			background-color: #dc3545;
			color: #fff;
		}
		
		.address-card.add-new {
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: #f8f9fa;
			border: 2px dashed #ced4da;
		}
		
		.address-card.add-new:hover {
			background-color: #e9ecef;
		}
		
		.address-card.add-new button {
			border: none;
			background: none;
			color: #6c757d;
			font-weight: bold;
			transition: all 0.3s ease;
		}
		
		.address-card.add-new button:hover {
			color: #007bff;
		}
		
		@media (max-width: 576px) {
			.address-grid {
				grid-template-columns: 1fr;
			}
		}
		
		.payment-options {
			display: flex;
			gap: 1rem;
			margin-bottom: 1.5rem;
		}
		
		.payment-option {
			flex: 1;
		}
		
		.payment-option input[type="radio"] {
			display: none;
		}
		
		.payment-option label {
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 1rem;
			background-color: white;
			border-radius: 10px;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		
		.payment-option input[type="radio"]:checked + label {
			background-color: #ebf5fb;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}
		
		.payment-option i {
			font-size: 2rem;
			margin-bottom: 0.5rem;
			color: #3498db;
		}
		
		.gift-card-input {
			display: flex;
			gap: 0.5rem;
		}
		
		.order-summary {
			background-color: white;
			border-radius: 10px;
			padding: 1.5rem;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}
		
		.order-items {
			margin-bottom: 1.5rem;
		}
		
		.order-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
			padding-bottom: 1rem;
			border-bottom: 1px solid #e0e0e0;
		}
		
		.item-info h6 {
			margin-bottom: 0.25rem;
		}
		
		.item-price {
			font-weight: 600;
		}
		
		.total-line {
			display: flex;
			justify-content: space-between;
			margin-bottom: 0.5rem;
		}
		
		.grand-total {
			font-size: 1.2rem;
			font-weight: 600;
			margin-top: 1rem;
			padding-top: 1rem;
			border-top: 2px solid #e0e0e0;
		}
		
		@media (max-width: 768px) {
			.checkout-wrapper {
				flex-direction: column;
			}
			
			.progress-steps {
				overflow-x: auto;
				padding-bottom: 1rem;
			}
			
			.progress-step {
				flex: 0 0 auto;
				width: 100px;
			}
		}
    </style>
</head>

<body id="category">

	<!-- Start Header Area -->
	<header class="header_area sticky-header">
		<div class="main_menu">
			<nav class="navbar navbar-expand-lg navbar-light main_box">
				<div class="container">
					<!-- Brand and toggle get grouped for better mobile display -->
					<a class="navbar-brand logo_h d-flex align-items-center" href="{% url 'home' %}">
						<img src="{% static 'img/logo2.png' %}" alt="Baka Store Logo" style="height: 4rem; width: 4rem; margin-right: 0.5rem;">
						<p class="brand-text" style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Baka Store</p>
					</a>
					
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
					 aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse offset" id="navbarSupportedContent">
						<ul class="nav navbar-nav menu_nav ml-auto">
							<li class="nav-item active"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
							<li class="nav-item submenu dropdown">
								<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
								 aria-expanded="false">Shop</a>
								<ul class="dropdown-menu">
									<li class="nav-item"><a class="nav-link" href="{% url 'category' %}">All Action Figures</a></li>
									<li class="nav-item"><a class="nav-link" href="#">New Arivals</a></li>
									<li class="nav-item"><a class="nav-link" href="#">Best Sellers</a></li>
									<li class="nav-item"><a class="nav-link" href="#">On Sale</a></li>
								</ul>
							</li>
							<li class="nav-item submenu dropdown">
								<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
								 aria-expanded="false">Character Types</a>
								<ul class="dropdown-menu">
									<li class="nav-item"><a class="nav-link" href="#">Heroes</a></li>
									<li class="nav-item"><a class="nav-link" href="#">Villains</a></li>
									<li class="nav-item"><a class="nav-link" href="#">Sidekicks</a></li>
									<li class="nav-item"><a class="nav-link" href="#">Monsters</a></li>
								</ul>
							</li>
							<li class="nav-item submenu dropdown">
								<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
								 aria-expanded="false">Account</a>
								<ul class="dropdown-menu">
									{% if user.is_authenticated %}
            							<li class="nav-item">
                							<a class="nav-link" href="{% url 'user-logout' %}">Logout</a>
            							</li>
										<li class="nav-item">
                							<a class="nav-link" href="{% url 'user-logout' %}">Wishlist</a>
            							</li>
										<li class="nav-item">
                							<a class="nav-link" href="{% url 'account_details' %}">Account Settings</a>
            							</li>
       	 							{% else %}
            							<li class="nav-item">
                							<a class="nav-link" href="{% url 'user-login' %}">Login</a>
           	 							</li>
        							{% endif %}
								</ul>
							</li>
							<li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
						</ul>
						<ul class="nav navbar-nav navbar-right">
							<li class="nav-item"><a href="#" class="cart"><span class="ti-bag"></span></a></li>
							<li class="nav-item">
								<button class="search"><span class="lnr lnr-magnifier" id="search"></span></button>
							</li>
						</ul>
					</div>
				</div>
			</nav>
		</div>
		<div class="search_input" id="search_input_box">
			<div class="container">
				<form class="d-flex justify-content-between">
					<input type="text" class="form-control" id="search_input" placeholder="Search Here">
					<button type="submit" class="btn"></button>
					<span class="lnr lnr-cross" id="close_search" title="Close Search"></span>
				</form>
			</div>
		</div>
	</header>
	<!-- End Header Area -->

	<!-- Start Banner Area -->
	<section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Checkout</h1>
                    <nav class="d-flex align-items-center">
                        <a href="{% url 'home' %}">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="{% url 'cart' %}">Cart<span class="lnr lnr-arrow-right"></span></a>
                        <a href="{% url 'checkout' %}">Checkout</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
	<!-- End Banner Area -->
	 
	<form method="post" action="{% url 'checkout' %}">
		{% csrf_token %}
		<section class="checkout-area py-5">
		<div class="container">
			<div class="checkout-wrapper">
				<div class="checkout-main">
					<!-- Progress Bar -->
					<div class="checkout-progress mb-5">
						<div class="progress-steps">
							<div class="progress-step active">
								<div class="step-icon">
									<i class="fas fa-user-circle"></i>
								</div>
								<span>Account</span>
							</div>
							<div class="progress-step">
								<div class="step-icon">
									<i class="fas fa-map-marker-alt"></i>
								</div>
								<span>Address</span>
							</div>
							<div class="progress-step">
								<div class="step-icon">
									<i class="fas fa-credit-card"></i>
								</div>
								<span>Payment</span>
							</div>
							<div class="progress-step">
								<div class="step-icon">
									<i class="fas fa-clipboard-check"></i>
								</div>
								<span>Review</span>
							</div>
						</div>
					</div>
	
					<!-- Account Section -->
					<div class="checkout-section account-details mb-5">
						<h3 class="section-title">Your Account</h3>
						<div class="account-card">
							<div class="account-info">
								<i class="fas fa-user-circle account-icon"></i>
								<div>
									<p class="mb-0"><strong>Logged in as:</strong></p>
									<p class="mb-0 user-email">{{ user.email }}</p>
								</div>
							</div>
							<a href="{% url 'user-logout' %}" class="btn btn-outline-danger">
								<i class="fas fa-sign-out-alt me-2"></i>Logout
							</a>
						</div>
					</div>
	
					<!-- Address Section -->
					<div class="checkout-section delivery-address mb-5">
						<h3 class="section-title">Delivery Address</h3>
						<div class="address-grid">
							{% for address in addresses %}
							<div class="address-card">
								<input type="radio" name="shipping_address" id="address{{ address.id }}" value="{{ address.id }}" {% if forloop.first %}checked{% endif %} class="address-radio">
								<label for="address{{ address.id }}" class="address-label">
									<div class="address-content">
										<h5 class="mb-2">{{ address.address_line1 }}</h5>
										<p class="mb-0">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
									</div>
								</label>
								<div class="address-actions">
									<button class="btn btn-sm btn-edit edit-address-btn" data-address-id="{{ address.id }}" title="Edit Address">
										<i class="fas fa-edit"></i>
									</button>
									<button type="button" class="btn btn-sm btn-delete delete-address-btn" data-address-id="{{ address.id }}" title="Delete Address">
										<i class="fas fa-trash-alt"></i>
									</button>
								</div>
							</div>
							{% endfor %}
							<div class="address-card add-new">
								<button type="button" class="btn btn-outline-primary w-100 h-100" id="addAddressBtn">
									<i class="fas fa-plus-circle"></i>
									<span>Add New Address</span>
								</button>
							</div>
						</div>
					</div>

					<!-- Address Section -->
					
	
					<!-- Payment Section -->
					<div class="checkout-section payment-section mb-5">
						<h3 class="section-title">Payment Method</h3>
						<div class="payment-options">
							<div class="payment-option">
								<input type="radio" name="payment_method" id="online_payment" value="ONLINE" checked>
								<label for="online_payment">
									<i class="fas fa-credit-card"></i>
									<span>Online Payment</span>
								</label>
							</div>
							<div class="payment-option">
								<input type="radio" name="payment_method" id="cod" value="cod">
								<label for="cod">
									<i class="fas fa-money-bill-wave"></i>
									<span>Cash on Delivery</span>
								</label>
							</div>
						</div>
	
						<div class="gift-card mt-4">
							<h5 class="mb-3">Have a Gift Card?</h5>
                            <div class="gift-card-input">
                                <input type="text" class="form-control" id="voucher_code" name="voucher_code" placeholder="Voucher Code">
                                <button class="btn btn-primary" type="button" id="apply_voucher">Apply</button>
                            </div>
                            <p id="coupon_message"></p>
						</div>
					</div>
				</div>
	
				<!-- Order Summary Section -->
				<div class="checkout-sidebar">
					<div class="order-summary">
						<h3 class="section-title">Order Summary</h3>
						<div class="order-items">
							{% for item in cart_items %}
							<div class="order-item">
								<div class="item-info">
									<h6>{{ item.variant.product.name }}</h6>
									<small>Size: {{ item.variant.size }}</small>
									<small>Qty: {{ item.quantity }}</small>
								</div>
								<span class="item-price">₹{{ item.discounted_price }}</span>
							</div>
							{% endfor %}
						</div>
						<div class="order-totals">
							<div class="total-line">
								<span>Subtotal</span>
								<strong>₹<span id="cart-subtotal">{{ cart_subtotal }}</span></strong>
							</div>
							<div class="total-line">
								<span>Shipping</span>
								<strong class="text-success">Free</strong>
							</div>
							{% if coupon %}
							<div id="discount-line" class="total-line">
								<span>Discount ({{ coupon.code }})</span>
								<strong class="text-danger">-₹<span id="discount-amount">{{ discount }}</span></strong>
							</div>
							{% endif %}
							<div class="total-line grand-total">
								<span>Total</span>
								<strong>₹<span id="cart-total">{{ cart_total }}</span></strong>
							</div>
						</div>
						<button class="btn btn-primary btn-lg w-100" type="submit">
							<i class="fas fa-lock me-2"></i>Place Order
						</button>
					</div>
				</div>
			</div>
		</section>
		
	</form>
	<!-- Add Addresses -->
	<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="addressModalLabel">Add New Address</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="newAddressForm">
						<div class="mb-3">
							<input type="text" class="form-control" id="addressLine1" name="address_line1" placeholder="Address Line 1" required>
						</div>
						<div class="mb-3">
							<input type="text" class="form-control" id="addressLine2" name="address_line2" placeholder="Address Line 2">
						</div>
						<div class="mb-3">
							<input type="text" class="form-control" id="city" name="city" placeholder="City" required>
						</div>
						<div class="mb-3">
							<input type="text" class="form-control" id="state" name="state" placeholder="State" required>
						</div>
						<div class="mb-3">
							<input type="text" class="form-control" id="postalCode" name="postal_code" placeholder="Postal Code" required>
						</div>
						<div class="mb-3">
							<input type="text" class="form-control" id="country" name="country" placeholder="Country" required>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="saveAddress">Save Address</button>
				</div>
			</div>
		</div>
	</div>
	<!-- start footer Area -->
	<footer class="footer-area section_gap">
		<div class="container">
			<div class="row">
				<div class="col-lg">
					<div class="single-footer-widget about-us-widget">
						<h6>About Us</h6>
						<p>
							Welcome to Baka Store, your ultimate destination for anime action figures. We are passionate about bringing your favorite characters to life with high-quality figures. Our mission is to provide anime enthusiasts with a wide variety of collectibles, ensuring that every fan can find something they love. At Baka Store, we are committed to delivering exceptional products and customer service. Join us in celebrating the world of anime!
						</p>
					</div>
				</div>
			</div>
			<div class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
				<p class="footer-text m-0">
					Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | Baka Store
				</p>
			</div>
			
		</div>
	</footer>
	<!-- End footer Area -->
	<script src="{% static 'js/vendor/jquery-2.2.4.min.js' %}"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
	 crossorigin="anonymous"></script>
	<script src="{% static 'js/vendor/bootstrap.min.js' %}"></script>
	<script src="{% static 'js/jquery.ajaxchimp.min.js' %}"></script>
	<script src="{% static 'js/jquery.nice-select.min.js' %}"></script>
	<script src="{% static 'js/jquery.sticky.js' %}"></script>
	<script src="{% static 'js/nouislider.min.js' %}"></script>
	<script src="{% static 'js/jquery.magnific-popup.min.js' %}"></script>
	<script src="{% static 'js/owl.carousel.min.js' %}"></script>
	<!--gmaps Js-->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
	<script src="{% static 'js/gmaps.min.js' %}"></script>
	<script src="{% static 'js/main.js' %}"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<script>
		$(document).ready(function() {
			// Add Address
			$('#addAddressBtn').click(function() {
				$('#newAddressForm')[0].reset();
				$('#addressId').val('');
				$('#addressModal').modal('show');
			});
			
			//edit address
			$('.edit-address-btn').click(function() {
                var addressId = $(this).data('address-id');
                $.get('/get-address/?id=' + addressId, function(data) {  
                    $('#addressId').val(data.id);
                    $('#addressLine1').val(data.address_line1);
                    $('#addressLine2').val(data.address_line2);
                    $('#city').val(data.city);
                    $('#state').val(data.state);
                    $('#postalCode').val(data.postal_code);
                    $('#country').val(data.country);
                    $('#addressModal').modal('show');
                });
            });

			// Save Address
			$('#saveAddress').click(function() {
				var formData = new FormData($('#newAddressForm')[0]);
				$.ajax({
					url: '/save-address/',  // Make sure this URL is correct
					type: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					headers: {
						'X-CSRFToken': getCookie('csrftoken')
					},
					success: function(response) {
						if (response.success) {
							alert('Address saved successfully');
							closeAddressModal();
							location.reload();
						} else {
							alert('Failed to save address');
						}
					},
					error: function() {
						alert('An error occurred. Please try again.');
					}
					
				});


				//Update hidden fields when  an address is selected
				$('input[name="address"]').change(function(){
					$('selected_address').val($(this).val());
				});


				//Update hidden fields when a payment method is selected
				$('input[name="payment_method"]').change(function(){
					$('#selected_payment_method').val($(this).val());
				});

				$('form').submit(function(e){
					e.preventDefault();

					var selectedAddress = $('#selected_address').val();
					var selectedPaymentMethod = $('#selected_payment_method').val();

					if(!selectedAddress){
						alert('Please select a shipping address.')
						return;
					}

					if(!selectedPaymentMethod){
						alert('Please select a payment method.')
						return;
					}

					this.submit();
				});

			});
			
			//Delete address
			$('.delete-address-btn').click(function(e) {
				e.preventDefault();
				e.stopPropagation();  // Prevent event from bubbling up
				var addressId = $(this).data('address-id');
				if (confirm('Are you sure you want to delete this address?')) {
					$.ajax({
						url: '/delete-address/' + addressId + '/',
						type: 'POST',
						headers: {
							'X-CSRFToken': getCookie('csrftoken')
						},
						success: function(response) {
							if (response.success) {
								alert('Address deleted successfully');
								location.reload();
							} else {
								alert('Failed to delete address: ' + response.error);
							}
						},
						error: function(xhr, status, error) {
							console.error(xhr.responseText);
							alert('An error occurred. Please try again.');
						}
					});
				}
			});

			//close the modal
			function closeAddressModal() {
				if (typeof bootstrap !== 'undefined') {
					var myModal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
					myModal.hide();
				} else {
					$('#addressModal').modal('hide');
				}
			}

			$('.btn-close, .btn-secondary[data-bs-dismiss="modal"]').click(function() {
				closeAddressModal();
			});

			document.getElementById('apply_voucher').addEventListener('click', function() {
				var couponCode = document.getElementById('voucher_code').value;
				fetch('{% url "apply_coupon" %}', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'X-CSRFToken': getCookie('csrftoken')
					},
					body: 'coupon_code=' + couponCode
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						document.getElementById('coupon_message').innerHTML = data.message;
						document.getElementById('cart-total').innerHTML = '₹' + data.new_total.toFixed(2);
						
						// Update or add discount line
						var discountLine = document.getElementById('discount-line');
						if (!discountLine) {
							discountLine = document.createElement('div');
							discountLine.id = 'discount-line';
							discountLine.className = 'total-line';
							document.querySelector('.order-totals').insertBefore(discountLine, document.querySelector('.grand-total'));
						}
						discountLine.innerHTML = `
							<span>Discount (${couponCode})</span>
							<strong class="text-danger">-₹${data.discount.toFixed(2)}</strong>
						`;
						discountLine.style.display = 'flex';
					} else {
						document.getElementById('coupon_message').innerHTML = data.message;
						// Remove discount line if coupon is invalid
						var discountLine = document.getElementById('discount-line');
						if (discountLine) {
							discountLine.remove();
						}
					}
				});
			});

			function getCookie(name) {
				let cookieValue = null;
				if (document.cookie && document.cookie !== '') {
					const cookies = document.cookie.split(';');
					for (let i = 0; i < cookies.length; i++) {
						const cookie = cookies[i].trim();
						if (cookie.substring(0, name.length + 1) === (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}

			// Function to show SweetAlert based on payment method and cart total
			function validatePayment() {
				const form = document.querySelector('form');
				const cartTotal = {{ cart_total }};
				const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
				const shippingAddress = document.querySelector('input[name="shipping_address"]:checked');
		
				form.addEventListener('submit', function(e) {
					if (!shippingAddress) {
						e.preventDefault();
						Swal.fire({
							icon: 'error',
							title: 'Address Required',
							text: 'Please select a shipping address to continue.',
							confirmButtonColor: '#3085d6',
						});
						return;
					}
		
					if (!selectedPayment) {
						e.preventDefault();
						Swal.fire({
							icon: 'error',
							title: 'Payment Method Required',
							text: 'Please select a payment method to continue.',
							confirmButtonColor: '#3085d6',
						});
						return;
					}
		
					if (cartTotal > 2000 && selectedPayment.value === 'COD') {
						e.preventDefault();
						Swal.fire({
							icon: 'error',
							title: 'Payment Method Not Allowed',
							text: 'Cash on Delivery is only available for orders up to ₹2,000. Please choose online payment.',
							confirmButtonColor: '#3085d6',
						});
						return;
					}
		
					if (selectedPayment.value === 'ONLINE') {
						// For online payment, let the form submit normally
						// The backend will handle the Razorpay integration
					} else {
						// For COD orders
						e.preventDefault();
						Swal.fire({
							title: 'Confirm Order',
							text: 'Are you sure you want to place this order with Cash on Delivery?',
							icon: 'question',
							showCancelButton: true,
							confirmButtonColor: '#3085d6',
							cancelButtonColor: '#d33',
							confirmButtonText: 'Yes, place order!',
							cancelButtonText: 'Cancel'
						}).then((result) => {
							if (result.isConfirmed) {
								form.submit();
							}
						});
					}
				});
			}
		
			// Initialize the validation
			document.addEventListener('DOMContentLoaded', function() {
				validatePayment();
		
				// Show success message if order is placed successfully
				{% if messages %}
					{% for message in messages %}
						{% if 'success' in message.tags %}
							Swal.fire({
								icon: 'success',
								title: 'Success!',
								text: '{{ message }}',
								confirmButtonColor: '#3085d6',
							});
						{% elif 'error' in message.tags %}
							Swal.fire({
								icon: 'error',
								title: 'Oops...',
								text: '{{ message }}',
								confirmButtonColor: '#3085d6',
							});
						{% endif %}
					{% endfor %}
				{% endif %}
			});
		});
		</script>
</body>

</html>